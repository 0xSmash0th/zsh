#compdef getopts read unset vared

# This will handle completion of keys of associative arrays, e.g. at
# `vared compconfig[<TAB>'.  However, in this version the [ must be
# added by hand.

local expl

if [[ $PREFIX = *\[* ]]; then
  local var=${PREFIX%%\[*}
  local elt="${PREFIX#*\]}${SUFFIX%\]}"
  local addclose

  compset -p $(( ${#var} + 1 ))
  if ! compset -S \]; then
    addclose=(-S ']')
  fi
  if [[ ${(tP)var} = assoc* ]]; then
    _description expl 'association key'
    compadd "$expl[@]" $addclose - ${(kP)var}
  fi
else
  _description expl parameter
  compgen "$expl[@]" -v
fi
